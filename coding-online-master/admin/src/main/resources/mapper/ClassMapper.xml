<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.biz.mapper.ClassMapper">
    <select id="getAllClass" resultType="com.chen.biz.vo.ClassInformation">
        SELECT class.class_id, class.class_name, IFNULL(student_nums, 0) AS student_nums
        FROM class
                 LEFT JOIN (SELECT user_class.class_id ,COUNT(user_class_id) AS student_nums
                            FROM user_class
                            WHERE is_delete = 0
                            GROUP BY class_id
        ) t
                           ON class.class_id = t.class_id
        WHERE class.is_delete = 0
    </select>

    <update id="updateClassByName">
        update
            class
        set
            class_name = #{newClass}
        where
            class_name = #{oldClass} and is_delete = 0
    </update>


    <select id="getClassSuccessNum"  resultType="com.chen.biz.vo.ClassInformation">
SELECT count(user_id) as studentNums,eee.class_name  from   class as ddd  left join
(select
 DISTINCT class.class_id,class_name,t.user_id
from
class
left join (select class_id,user_id from user_class) s
on s.class_id=class.class_id
left join (

select DISTINCT sss.judge_task_id,sss.user_id  from  judge_task
left join (select user_id,judge_task_id from judge_result ) as   sss
on
sss.judge_task_id=judge_task.judge_task_id
left join (select user_id,`status` from  judge_result ) jres on jres.user_id=sss.user_id
where question_id=#{order} and  jres.`status`=0
)
t on t.user_id=s.user_id)  eee
on  eee.class_id=ddd.class_id
where is_delete=0
GROUP BY class_name
     </select>


    <select id="getClassSubmitNum"  resultType="com.chen.biz.vo.ClassInformation">

SELECT count(user_id) as studentNums,eee.class_name  from   class as ddd  left join
(select
 DISTINCT class.class_id,class_name,t.user_id
from
class
left join (select class_id,user_id from user_class) s
on s.class_id=class.class_id
left join (

select DISTINCT sss.judge_task_id,sss.user_id  from  judge_task
left join (select user_id,judge_task_id from judge_result ) as   sss
on
sss.judge_task_id=judge_task.judge_task_id
left join (select user_id,`status` from  judge_result) jres on jres.user_id=sss.user_id
where question_id=#{order}
)
t on t.user_id=s.user_id)  eee
on  eee.class_id=ddd.class_id
where is_delete=0
GROUP BY class_name
     </select>


    <select id="getNumWithWeekByQuestionId" resultType="com.chen.biz.vo.ClassInformation">

				SELECT  judge_result.create_time,count(DISTINCT judge_result.user_id) as student_nums FROM
				judge_result,judge_task,question
				WHERE
				YEARWEEK(date_format(judge_result.create_time,'%Y-%m-%d')) = YEARWEEK(now())
			   and
				 judge_task.judge_task_id=judge_result.judge_task_id
				 and
				 judge_task.question_id=#{questionId}
				 and judge_result.is_delete=0 and `status`=0
				 GROUP BY judge_result.create_time
    </select>

    <select id="getSuccessNumWithWeekByQuestionId" resultType="Integer">
select COUNT(DISTINCT judge_result.user_id)
from
judge_task,
judge_result
where
judge_task.judge_task_id=judge_result.judge_task_id
and
judge_task.question_id=#{questionId}
and
judge_result.is_delete=0
and `status`=0
    </select>
    <select id="getAllNumWithWeekByQuestionId" resultType="Integer">
select COUNT(DISTINCT judge_result.user_id)
from
judge_task,
judge_result
where
judge_task.judge_task_id=judge_result.judge_task_id
and
judge_task.question_id=#{questionId}
and
judge_result.is_delete=0
    </select>
</mapper>
